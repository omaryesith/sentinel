name: Sentinel CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Services
        run: make build

      - name: Create .env file for CI
        run: |
          echo "DEBUG=True" > ./app/.env
          echo "SECRET_KEY=${{ secrets.CI_SECRET_KEY || 'django-insecure-ci-test-key-do-not-use-in-production-12345' }}" >> ./app/.env
          echo "ALLOWED_HOSTS=*" >> ./app/.env
          echo "POSTGRES_DB=sentinel" >> ./app/.env
          echo "POSTGRES_USER=postgres" >> ./app/.env
          echo "POSTGRES_PASSWORD=postgres" >> ./app/.env
          echo "POSTGRES_HOST=db" >> ./app/.env
          echo "POSTGRES_PORT=5432" >> ./app/.env
          echo "REDIS_URL=redis://redis:6379/0" >> ./app/.env

      - name: Start Database and Redis only
        run: docker compose up -d db redis

      - name: Wait for Database
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            docker compose exec -T db pg_isready -U postgres && break
            echo "Waiting for database... ($i/30)"
            sleep 2
          done
          echo "Database is ready!"

      - name: Run Migrations
        run: make migrate

      - name: Run Tests
        run: make test

      - name: Tear down
        if: always()
        run: docker compose down

